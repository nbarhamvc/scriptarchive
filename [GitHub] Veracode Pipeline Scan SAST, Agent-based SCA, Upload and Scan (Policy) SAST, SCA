name: Development branch
# 
on:
  push:
    branches: [development]

jobs:
  App-build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'adopt'
      - name: Build with Maven
        run: mvn --batch-mode --update-snapshots package
      
      - name: Upload war file
        uses: actions/upload-artifact@v3
        with:
          name: verademo.war
          path: target/verademo.war

  Pipeline-Scan:
      needs: App-build
      runs-on: ubuntu-latest
      container: 
        image: veracode/pipeline-scan:latest
        options: --user root
      steps:
        - name: get archive
          uses: actions/download-artifact@v2
          with:
            name: verademo.war
            path: /tmp
        - name: pipeline-scan
          run: | 
            java -jar /opt/veracode/pipeline-scan.jar \
              -vid "${{secrets.VERACODE_API_ID}}" \
              -vkey "${{secrets.VERACODE_API_KEY}}" \
              --file /tmp/verademo.war \
              -jf results.json \
              -fjf filtered_results.json 
          continue-on-error: true
        - name: save standard results
          uses: actions/upload-artifact@v1
          with:
            name: PipelineScanResults
            path: results.json
        - name: save filtered results
          uses: actions/upload-artifact@v1
          with:
            name: filtered-results
            path: filtered_results.json
        - name: Convert pipeline scan output to SARIF format 
          id: convert
          uses: veracode/veracode-pipeline-scan-results-to-sarif@v0.1.5
          with:
            pipeline-results-json: results.json
            source-base-path-1: "^com/veracode:src/main/java/com/veracode"
            source-base-path-2: "^WEB-INF:src/main/webapp/WEB-INF"       

  import-issues:
    needs: Pipeline-scan
    runs-on: ubuntu-latest
    steps:
      - name: get scan results
        uses: actions/download-artifact@v2
        with:
          name: filtered-results

      - name: import flaws as issues
        uses: buzzcode/veracode-flaws-to-issues@v1
        with:
          scan-results-json: 'filtered_results.json'
          github-token: ${{ secrets.GITHUB_TOKEN }}

  Veracode-Pipeline-Scan-action:
    needs: App-build
    runs-on: ubuntu-latest
    steps:
        - name: get archive
          uses: actions/download-artifact@v2
          with:
            name: verademo.war
            path: /tmp
    
        - name: Veracode Pipeline-Scan action
          uses: veracode/Veracode-pipeline-scan-action@pipeline-scan-beta-v0.0.4
          with:
            vid: "${{secrets.VERACODE_API_ID}}"
            vkey: "${{secrets.VERACODE_API_KEY}}"
            file: /tmp/verademo.war
            token: ${{ secrets.GITHUB_TOKEN }}
  
  Agent-based-SCA:
        runs-on: ubuntu-latest
        name: Agent-based-SCA

        steps:
          - name: Checkout
            uses: actions/checkout@v2
          - name: Run Veracode SCA
            env:
              SRCCLR_API_TOKEN: ${{ secrets.SRCCLR_API_TOKEN }}
            uses: veracode/veracode-sca@v1.09
            with:
              github_token: ${{ secrets.GITHUB_TOKEN }}
              create-issues: false

  Veracode-Policy-Scan:
      runs-on: ubuntu-latest
      needs: App-build
      steps:
        - name: Checkout
          uses: actions/checkout@v2

        - name: Download war file
          uses: actions/download-artifact@v3
          with: 
            name: verademo.war
            path: .
      
        - name: Policy Scan
          uses: veracode/veracode-uploadandscan-action@master
          with:
            createprofile: true
            appname: "verademo-github"
            version: '${{ github.run_id }}'
            filepath: 'verademo.war'
            vid: '${{ secrets.VERACODE_API_ID }}'
            vkey: '${{ secrets.VERACODE_API_KEY }}'
            scantimeout: 15
